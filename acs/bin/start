#!/bin/bash	
AGENT=""

FAT_JAR_PARAMS="$HTTP_PORT "$SP_PARAMS

echo "APP_NAME = $APP_NAME"

echo "FAT_JAR_PARAMS = $FAT_JAR_PARAMS"

function ExportPath(){
        echo "Begin ExportEnv"
        export PATH=$PATH:/acs/user/jdk/bin:/acs/bin
        export CLASSPATH=/acs/user/jdk/lib:$CLASSPATH
        export LANG=en_US.UTF-8
}

function GetAgent(){
        if  [ ! -n "$CONF_AGENT" ] ;then
        echo "CONF_AGENT IS NULL"
        else
        echo "get agent"
        echo "$CONF_AGENT"
        echo "wget agentzip from $CONF_AGENT"
        wget -nv -O /acs/agent.zip $CONF_AGENT
        unzip -q -o /acs/agent.zip -d /acs/agent
        AGENT=$(find /acs/agent  -name "*agent.jar" | head -n 1)
        echo "agent app is $AGENT"
        fi
}

function Start(){
	rm -f tpid
	if  [ ! -n "$AGENT" ] ;then
	    exec java $JAVA_OPTS -jar /acs/user/src/$APP_NAME.jar ${FAT_JAR_PARAMS} > /dev/stdout 2>&1 &
	else
	    exec java -javaagent:$AGENT $JAVA_OPTS -jar /acs/user/src/$APP_NAME.jar ${FAT_JAR_PARAMS} > /dev/stdout 2>&1 &
	fi
	echo "/acs/user/src/$APP_NAME.jar"
	echo $! > tpid
	echo Start springboot Success!
}

function Cpapp(){
	echo "Begin to copy app code to webapps"                                                                                                                                                                                         
	CODE_EXIST=`ls /acs/code`                                                                                                                                                                                                    
	if [ ! -z "$CODE_EXIST" ];then                                                                                                                                                                                              
        rm -fr /acs/user/src/
        mkdir -p /acs/user/src
        cp -R /acs/code/* /acs/user/src/
	fi
}

#main
ExportPath

GetAgent

Cpapp

Start
